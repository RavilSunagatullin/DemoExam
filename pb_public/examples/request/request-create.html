<!doctype html>
<html lang="ru" data-theme="light">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Новая заявка</title>

        <script>
            window.PB_BASE_URL = window.PB_BASE_URL || "http://127.0.0.1:8090";
            window.APP_ROUTES = Object.assign(
                {
                    home: "/views/home.html",
                    createRequest: "/views/request-create.html",
                    requests: "/views/requests.html",
                    login: "/auth/login.html",
                },
                window.APP_ROUTES || {},
            );
        </script>

        <link rel="stylesheet" href="/assets/pico.min.css" />
        <link rel="stylesheet" href="/assets/app.css" />
    </head>
    <body>
        <main class="app-page" x-data="createPage" x-init="init()">
            <nav>
                <ul>
                    <li><a :href="routes.home">Главная</a></li>
                    <li><strong>Новая заявка</strong></li>
                </ul>
                <ul>
                    <li>
                        <a :href="pbUrl" target="_blank" rel="noreferrer">PocketBase</a>
                    </li>
                    <li>
                        <button type="button" @click="doLogout()">Выйти</button>
                    </li>
                </ul>
            </nav>

            <article class="app-fade-in">
                <header>
                    <h1 style="margin-bottom: 0.25rem">Формирование заявки</h1>
                    <p class="app-muted" style="margin: 0">
                        Заполните все поля и отправьте заявку на тест-драйв
                    </p>
                </header>

                <form @submit.prevent="submit()">
                    <div class="app-grid cols-2">
                        <section>
                            <h3 style="margin-top: 0">Контактные данные</h3>

                            <label for="fio">ФИО</label>
                            <input
                                id="fio"
                                type="text"
                                required
                                pattern="^[А-ЯЁа-яё]+(?:\s+[А-ЯЁа-яё]+)*$"
                                x-model.trim="form.fio"
                                :disabled="loading"
                            />

                            <label for="email">Email</label>
                            <input
                                id="email"
                                type="email"
                                required
                                x-model.trim="form.email"
                                :disabled="loading"
                            />

                            <label for="phone">Телефон</label>
                            <input
                                id="phone"
                                type="tel"
                                required
                                placeholder="+7(999)-123-45-67"
                                pattern="^\+7\([0-9]{3}\)-[0-9]{3}-[0-9]{2}-[0-9]{2}$"
                                inputmode="tel"
                                autocomplete="tel"
                                x-model.trim="form.phone"
                                @input="onPhone($event)"
                                :disabled="loading"
                            />
                            <small class="app-muted">Формат: +7(XXX)-XXX-XX-XX</small>

                            <label for="address">Адрес</label>
                            <input
                                id="address"
                                type="text"
                                required
                                x-model.trim="form.address"
                                :disabled="loading"
                            />
                        </section>

                        <section>
                            <h3 style="margin-top: 0">Параметры тест-драйва</h3>

                            <label for="desiredAt">Желаемая дата и время</label>
                            <input
                                id="desiredAt"
                                type="datetime-local"
                                required
                                x-model="form.desiredAt"
                                :disabled="loading"
                            />

                            <label>Марка</label>
                            <select
                                required
                                x-model="selectedBrand"
                                @change="onBrandChange()"
                                :disabled="loading || carsLoading"
                            >
                                <option value="" selected>Выберите марку</option>
                                <template x-for="b in brands" :key="b">
                                    <option :value="b" x-text="b"></option>
                                </template>
                            </select>

                            <label>Модель</label>
                            <select
                                required
                                x-model="selectedCarId"
                                :disabled="loading || carsLoading || !selectedBrand"
                            >
                                <option value="" selected>Выберите модель</option>
                                <template x-for="c in models" :key="c.id">
                                    <option :value="c.id" x-text="c.model"></option>
                                </template>
                            </select>
                            <small class="app-muted" x-show="carsEmpty" x-cloak>
                                Список автомобилей пуст. Создайте коллекцию <strong>cars</strong> и
                                добавьте минимум 3 марки и 5 моделей.
                            </small>

                            <label>Тип оплаты</label>
                            <select
                                required
                                x-model="form.paymentType"
                                :disabled="loading"
                            >
                                <option value="" selected>Выберите</option>
                                <option value="cash">Наличными</option>
                                <option value="card">Банковской картой</option>
                            </select>
                        </section>
                    </div>

                    <hr />

                    <section>
                        <h3 style="margin-top: 0">Водительское удостоверение</h3>
                        <div class="app-grid cols-2">
                            <div>
                                <label for="series">Серия</label>
                                <input
                                    id="series"
                                    type="text"
                                    required
                                    x-model.trim="form.licenseSeries"
                                    :disabled="loading"
                                />
                            </div>

                            <div>
                                <label for="number">Номер</label>
                                <input
                                    id="number"
                                    type="text"
                                    required
                                    x-model.trim="form.licenseNumber"
                                    :disabled="loading"
                                />
                            </div>

                            <div>
                                <label for="issuedAt">Дата выдачи</label>
                                <input
                                    id="issuedAt"
                                    type="date"
                                    required
                                    x-model="form.licenseIssuedAt"
                                    :disabled="loading"
                                />
                            </div>
                        </div>
                    </section>

                    <hr />

                    <label>
                        <input
                            type="checkbox"
                            x-model="form.rulesAccepted"
                            :disabled="loading"
                        />
                        Я ознакомлен(а) с правилами предоставления услуги тест-драйва и подтверждаю,
                        что введённые данные верны.
                    </label>

                    <button
                        type="submit"
                        :aria-busy="loading"
                        :disabled="loading || !form.rulesAccepted"
                    >
                        <span x-show="!loading">Отправить заявку</span>
                        <span x-show="loading" x-cloak>Отправляем...</span>
                    </button>

                    <p class="app-muted" style="margin-top: 0.5rem">
                        Если чекбокс не отмечен — кнопка отправки неактивна.
                    </p>

                    <p class="error-text" x-show="error" x-text="error" x-cloak></p>
                </form>
            </article>
        </main>

        <script src="/assets/pocketbase.umd.js"></script>
        <script type="module">
            import {
                pb,
                requireAuth,
                authRecord,
                logout,
            } from "/assets/pocketbase.core.js";
            import {
                pbAdminUrl,
                formatRuPhone,
                isValidRuPhone,
                isValidCyrFio,
                toast,
                setFlash,
            } from "/assets/app.js";

            requireAuth({ loginPath: window.APP_ROUTES.login });

            const registerPage = () => {
                Alpine.data("createPage", () => ({
                    routes: window.APP_ROUTES,
                    pbUrl: pbAdminUrl(),
                    loading: false,
                    error: "",

                    carsLoading: false,
                    carsEmpty: false,
                    cars: [],
                    brands: [],
                    models: [],
                    selectedBrand: "",
                    selectedCarId: "",

                    form: {
                        fio: "",
                        email: "",
                        phone: "",
                        address: "",
                        desiredAt: "",
                        paymentType: "",
                        licenseSeries: "",
                        licenseNumber: "",
                        licenseIssuedAt: "",
                        rulesAccepted: false,
                    },

                    async init() {
                        const me = authRecord();
                        this.form.fio = me?.userFIO || "";
                        this.form.email = me?.email || "";
                        this.form.phone = me?.phone || "";
                        await this.loadCars();
                    },

                    doLogout() {
                        logout();
                        location.replace(this.routes.login);
                    },

                    onPhone(event) {
                        const formatted = formatRuPhone(
                            event?.target?.value || this.form.phone,
                        );
                        this.form.phone = formatted;
                        if (event?.target) event.target.value = formatted;
                    },

                    async loadCars() {
                        this.carsLoading = true;
                        this.carsEmpty = false;
                        try {
                            const list = await pb
                                .collection("cars")
                                .getFullList({ sort: "+brand,+model" });

                            this.cars = Array.isArray(list) ? list : [];

                            const set = new Set(
                                this.cars
                                    .map((c) => c.brand)
                                    .filter(Boolean)
                                    .map(String),
                            );
                            this.brands = Array.from(set).sort((a, b) =>
                                a.localeCompare(b, "ru"),
                            );
                            this.carsEmpty = this.cars.length === 0;
                        } catch (e) {
                            // If collection doesn't exist yet.
                            this.carsEmpty = true;
                        } finally {
                            this.carsLoading = false;
                        }
                    },

                    onBrandChange() {
                        this.selectedCarId = "";
                        this.models = this.cars
                            .filter((c) => c.brand === this.selectedBrand)
                            .map((c) => ({ id: c.id, model: c.model }));
                    },

                    validate() {
                        if (!isValidCyrFio(this.form.fio))
                            return "ФИО: только кириллица и пробелы";
                        if (!this.form.email) return "Введите email";
                        if (!isValidRuPhone(this.form.phone))
                            return "Телефон: формат +7(999)-123-45-67";
                        if (!this.form.address) return "Введите адрес";
                        if (!this.form.desiredAt)
                            return "Укажите дату и время записи";
                        if (!this.selectedCarId) return "Выберите марку и модель";
                        if (!this.form.paymentType) return "Выберите тип оплаты";
                        if (!this.form.licenseSeries) return "Введите серию ВУ";
                        if (!this.form.licenseNumber) return "Введите номер ВУ";
                        if (!this.form.licenseIssuedAt)
                            return "Введите дату выдачи ВУ";
                        if (!this.form.rulesAccepted)
                            return "Подтвердите ознакомление с правилами";
                        return "";
                    },

                    async submit() {
                        this.error = "";
                        const v = this.validate();
                        if (v) {
                            this.error = v;
                            toast(v, { kind: "error" });
                            return;
                        }

                        this.loading = true;
                        try {
                            const me = authRecord();

                            await pb.collection("requests").create({
                                user: me?.id,
                                fio: this.form.fio,
                                email: this.form.email,
                                phone: this.form.phone,
                                address: this.form.address,
                                desiredAt: new Date(this.form.desiredAt).toISOString(),
                                paymentType: this.form.paymentType,
                                car: this.selectedCarId,
                                licenseSeries: this.form.licenseSeries,
                                licenseNumber: this.form.licenseNumber,
                                licenseIssuedAt: this.form.licenseIssuedAt,
                                rulesAccepted: true,
                                status: "pending",
                            });

                            setFlash("Заявка отправлена", "success");
                            location.replace(this.routes.requests);
                        } catch (e) {
                            const msg = e?.message || "Не удалось отправить заявку";
                            this.error = msg;
                            toast(msg, { kind: "error" });
                        } finally {
                            this.loading = false;
                        }
                    },
                }));
            };

            if (window.Alpine) {
                registerPage();
            } else {
                document.addEventListener("alpine:init", registerPage, {
                    once: true,
                });
            }
        </script>
        <script src="/assets/alpine.min.js" defer></script>
    </body>
</html>
