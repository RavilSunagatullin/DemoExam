<!doctype html>
<html lang="ru" data-theme="light">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Register</title>

        <script>
            window.PB_BASE_URL = window.PB_BASE_URL || "http://127.0.0.1:8090";
            window.APP_ROUTES = Object.assign(
                {
                    home: "/home.html",
                    login: "/login.html",
                },
                window.APP_ROUTES || {},
            );
        </script>

        <link rel="stylesheet" href="/assets/pico.min.css" />
        <style>
            [x-cloak] {
                display: none !important;
            }

            .auth-wrap {
                min-height: 100vh;
                display: grid;
                place-items: center;
                padding: 1rem;
            }

            .auth-card {
                width: min(520px, 100%);
            }

            .error-text {
                color: #b91c1c;
            }
        </style>
    </head>
    <body>
        <main class="auth-wrap" x-data="registerPage" x-init="init()">
            <article class="auth-card">
                <header>
                    <h1>Регистрация</h1>
                    <p><small>Создание нового пользователя</small></p>
                </header>

                <form @submit.prevent="submit()">
                    <label for="username">Логин</label>
                    <input
                        id="username"
                        name="username"
                        type="text"
                        maxlength="250"
                        required
                        x-model.trim="form.username"
                        :disabled="loading"
                    />

                    <label for="password">Пароль</label>
                    <input
                        id="password"
                        name="password"
                        type="password"
                        minlength="6"
                        maxlength="250"
                        required
                        x-model="form.password"
                        :disabled="loading"
                    />

                    <label for="userFIO">ФИО</label>
                    <input
                        id="userFIO"
                        name="userFIO"
                        type="text"
                        required
                        pattern="^[А-ЯЁа-яё]+(?:\s+[А-ЯЁа-яё]+)+$"
                        x-model.trim="form.userFIO"
                        :disabled="loading"
                    />

                    <label for="phone">Телефон</label>
                    <input
                        id="phone"
                        name="phone"
                        type="tel"
                        maxlength="250"
                        required
                        pattern="^\+7 \([0-9]{3}\) [0-9]{3} [0-9]{2}-[0-9]{2}$"
                        placeholder="+7 (___) ___ __-__"
                        inputmode="tel"
                        autocomplete="tel"
                        x-model.trim="form.phone"
                        @input="formatPhone($event)"
                        :disabled="loading"
                    />

                    <label for="email">Почта</label>
                    <input
                        id="email"
                        name="email"
                        type="email"
                        maxlength="250"
                        required
                        x-model.trim="form.email"
                        :disabled="loading"
                    />

                    <button
                        type="submit"
                        :aria-busy="loading"
                        :disabled="loading"
                    >
                        <span x-show="!loading">Зарегистрироваться</span>
                        <span x-show="loading" x-cloak>Создаем...</span>
                    </button>
                </form>

                <p
                    ><small
                        >Уже есть аккаунт?
                        <a href="/login.html">Войти</a></small
                    ></p
                >
                <p class="error-text" x-show="error" x-text="error" x-cloak></p>
            </article>
        </main>

        <script src="/assets/pocketbase.umd.js"></script>
        <script type="module">
            import { isAuthed, register } from "/assets/pocketbase.core.js";

            const fioRegex = /^[А-ЯЁа-яё]+(?:\s+[А-ЯЁа-яё]+)+$/;

            const registerPageComponent = () => ({
                loading: false,
                error: "",
                form: {
                    username: "",
                    password: "",
                    userFIO: "",
                    phone: "",
                    email: "",
                },
                init() {
                    if (isAuthed()) {
                        location.replace(window.APP_ROUTES.home);
                    }
                },
                validate() {
                    if (!this.form.username) return "Введите login";
                    if (this.form.username.length > 250)
                        return "Login не должен превышать 250 символов";
                    if (!this.form.password || this.form.password.length < 6)
                        return "Password минимум 6 символов";
                    if (this.form.password.length > 250)
                        return "Password не должен превышать 250 символов";
                    if (!fioRegex.test(this.form.userFIO))
                        return "ФИО должно быть на кириллице и содержать минимум 2 слова";
                    if (!this.form.phone) return "Введите телефон";
                    if (this.form.phone.length > 250)
                        return "Phone не должен превышать 250 символов";
                    if (
                        !/^\+7 \(\d{3}\) \d{3} \d{2}-\d{2}$/.test(
                            this.form.phone,
                        )
                    )
                        return "Номер должен быть в формате +7 (999) 233 99-90";
                    if (!this.form.email) return "Введите email";
                    if (this.form.email.length > 250)
                        return "Email не должен превышать 250 символов";
                    return "";
                },
                formatPhone(event) {
                    const raw = (
                        event?.target?.value ||
                        this.form.phone ||
                        ""
                    ).replace(/\D/g, "");
                    if (!raw) {
                        this.form.phone = "";
                        return;
                    }

                    let digits = raw;
                    if (digits.startsWith("8")) {
                        digits = "7" + digits.slice(1);
                    } else if (digits.startsWith("9")) {
                        digits = "7" + digits;
                    } else if (!digits.startsWith("7")) {
                        digits = "7" + digits;
                    }
                    digits = digits.slice(0, 11);

                    let formatted = "+7";
                    if (digits.length > 1)
                        formatted += " (" + digits.slice(1, 4);
                    if (digits.length >= 4) formatted += ")";
                    if (digits.length > 4)
                        formatted += " " + digits.slice(4, 7);
                    if (digits.length > 7)
                        formatted += " " + digits.slice(7, 9);
                    if (digits.length > 9)
                        formatted += "-" + digits.slice(9, 11);

                    this.form.phone = formatted;
                    if (event?.target) event.target.value = formatted;
                },
                async submit() {
                    this.error = "";
                    const validationError = this.validate();
                    if (validationError) {
                        this.error = validationError;
                        return;
                    }

                    this.loading = true;
                    try {
                        await register(
                            {
                                username: this.form.username,
                                password: this.form.password,
                                passwordConfirm: this.form.password,
                                userFIO: this.form.userFIO,
                                phone: this.form.phone,
                                email: this.form.email,
                            },
                            "users",
                            { autoLogin: true },
                        );

                        location.replace(window.APP_ROUTES.home);
                    } catch (e) {
                        this.error =
                            extractFieldError(e) ||
                            e?.message ||
                            "Ошибка регистрации";
                    } finally {
                        this.loading = false;
                    }
                },
            });

            const extractFieldError = (error) => {
                const data = error?.fieldErrors;
                if (!data || typeof data !== "object") return "";
                const entries = Object.entries(data);
                if (!entries.length) return "";

                const [field, value] = entries[0];
                const msg = value?.message || "Некорректное значение";
                return `${field}: ${msg}`;
            };

            const registerRegisterPage = () => {
                Alpine.data("registerPage", registerPageComponent);
            };

            if (window.Alpine) {
                registerRegisterPage();
            } else {
                document.addEventListener("alpine:init", registerRegisterPage, {
                    once: true,
                });
            }
        </script>
        <script src="/assets/alpine.min.js" defer></script>
    </body>
</html>
